<HTML>
<HEAD>
<TITLE>Verhinderung von SQL Injection Marke .NET</TITLE>
<META HTTP-EQUIV="content-type: text/html; charset= ISO-8859-1">
<META HTTP-EQUIV="Content-Language" CONTENT="DE">
<META NAME="robots" CONTENT="FOLLOW,INDEX">
<META NAME="generator" CONTENT="Xitra Site Publishing">
<meta name="Author" content="webmaster@aspheute.com">

<META NAME="revisit-after" CONTENT="7 days">
<META NAME="copyright" CONTENT="(c) 2000-2006. Alle Rechte vorbehalten. Der Inhalt dieser Seiten ist urheberrechtlich geschützt.">
<META HTTP-EQUIV="expires" CONTENT="1999-03-30T00:00:00+00:00"> 
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<META HTTP-EQUIV="Cache-Control" CONTENT="no-store">

<meta http-equiv="Description" name="Description" content="Was SQL Injection ist, hat der erste Artikel dieser Serie ausf&uuml;hrlich erkl&auml;rt und auch demonstriert. Heute wechseln wir von ASP nach ASP.NET, und von ADO zu ADO.NET - und sehen uns die dortigen Abwehrmethoden an.">
<meta http-equiv="Keywords" name="Keywords" content="ASP,Active Server Pages,IIS,Internet Information Server,PWS,Personal Web Server,ADO,SQL Injection,Bastion,last line of defense,ASP.NET,SqlCommand,SqlConnection,ADO.NET">
<link rel="stylesheet" href="../includes/default.css">
</HEAD>
<BODY BGCOLOR="#ffffff"  BACKGROUND="../images/layout/aspheutemainbg.gif" >


<div style="border-bottom: solid 5px white;">
<div class="DotNetGermanCommunityBar">
    <a href="http://www.glengamoi.com">Glengamoi (Forum)</a> &middot;
    <a href="http://www.aspheute.com/" style="font-weight: bold">AspHeute</a> &middot;
    <a href="http://dotnetheute.com/">.NET Heute (RSS-Suche)</a> &middot;
    <a href="http://aspxfiles.com/">AspxFiles (Wiki)</a> &middot;
    <a href="http://blogs.dotnetgerman.com/">.NET Blogs</a>
</div>
</div>


<MAP NAME="titlebar">
<!--<AREA SHAPE=RECT COORDS="116,46,191,61" HREF="http://www.aspaktuell.com" ALT="ASP Aktuell">-->
<!--<AREA SHAPE=RECT COORDS="192,46,255,61" HREF="http://www.aspwelt.com" ALT="ASP Welt">-->
<AREA SHAPE=RECT COORDS="256,46,432,61" HREF="http://www.aspgerman.com/aspgerman/" ALT="ASP German">
<AREA SHAPE=RECT COORDS="115,15,269,42" HREF="../default.htm" ALT="Homepage">
<AREA SHAPE=RECT COORDS="278,26,587,42" HREF="../default.htm" ALT="Homepage">
</MAP>

<div style="position:absolute;left:0px;top:30px">
<table border=0 cellspacing=0 cellpadding=0>
<tr>
<td background="../images/layout/aspheutetitle.gif">
<img src="../images/layout/blind.gif" width="715" height="73" usemap="#titlebar" border="0">
</td>
<td width="100%" background="../images/layout/aspheutetitleext.gif">
&nbsp;
</td>
<td background="../images/layout/aspheutetitleend.gif">
<img src="../images/layout/blind.gif" width="25" height="1">
</td>
</tr>
</table>
</div>

<div style="position:absolute;left:1px;top:115px">
<table width="110" border="0" cellspacing="0" cellpadding="0">
<tr><td width="110"><img src="../Images/spacer.gif" width="110" height="1" alt="" border="0"></td></tr>
<tr>
<td background="../images/layout/aspheuteheader.gif" class="header" height=16 width="110">
<p>Liste</p>
</td>
</tr>
<tr>
<td background="../images/layout/aspheuteheaderext.gif" class="header" width="110">

<p class="content">
<a href="../kategorien/dotNET%202dot0.htm">.NET 2.0 (1)</a><br>
<a href="../kategorien/dotNET%20Allgemein.htm">.NET Allgemein (16)</a><br>
<a href="../kategorien/dotNET%20Fu.htm">.NET Fu (5)</a><br>
<a href="../kategorien/ADOdotNET.htm">ADO.NET (11)</a><br>
<a href="../kategorien/Aprilscherz.htm">Aprilscherz (3)</a><br>
<a href="../kategorien/ASP%20Grundlagen.htm">ASP Grundlagen (44)</a><br>
<a href="../kategorien/ASP%20Tricks.htm">ASP Tricks (83)</a><br>
<a href="../kategorien/ASPdotNET.htm">ASP.NET (44)</a><br>
<a href="../kategorien/ASPIntranetdotde.htm">ASPIntranet.de (5)</a><br>
<a href="../kategorien/Csharp.htm">C# (28)</a><br>
<a href="../kategorien/Datenbank.htm">Datenbank (44)</a><br>
<a href="../kategorien/Dokumentation.htm">Dokumentation (4)</a><br>
<a href="../kategorien/IIS%206dot0.htm">IIS 6.0 (1)</a><br>
<a href="../kategorien/Komponenten.htm">Komponenten (29)</a><br>
<a href="../kategorien/Optimierung.htm">Optimierung (10)</a><br>
<a href="../kategorien/Server.htm">Server (21)</a><br>
<a href="../kategorien/Sicherheit.htm">Sicherheit (34)</a><br>
<a href="../kategorien/Tee%20Off.htm">Tee Off (6)</a><br>
<a href="../kategorien/VBdotNET.htm">VB.NET (6)</a><br>
<a href="../kategorien/WAP.htm">WAP (8)</a><br>
<a href="../kategorien/Web%20Services.htm">Web Services (11)</a><br>
<a href="../kategorien/XML.htm">XML (9)</a><br>


<br>
<a href="/syndication/rss.xml"><img src="../Images/rss_small.png" width="25" height="10" alt="RSS 2.0 - Die neuesten f&uuml;nf Artikel auf AspHeute.com" border="0"></a>

</p><!-- </p> remains -->


<br>

</td>
</tr>
<tr>
<td class="empty" width="110">
&nbsp;
</td>
</tr>
<tr>
<td background="../images/layout/aspheutesearch.gif" class="header" height=16 width="110">
<p>Suchen</p>
</td>
</tr>
<tr>
<td background="../images/layout/aspheutesearchext.gif" class="header" width="110">
<form class="content" ACTION="REMOVED" METHOD="GET">
<div>
<input class="Newsletter" type="text" size="10" name="CiRestriction">
<span class="spacer2"><br></span>
<span class="spacer4"><br></span>
<INPUT TYPE="HIDDEN" NAME="CiMaxRecordsPerPage" VALUE="10">
<INPUT TYPE="HIDDEN" NAME="CiSort" VALUE="rank[d]">
<INPUT TYPE="HIDDEN" NAME="HTMLQueryForm" VALUE="../default.htm">
<img src="../images/layout/blind.gif" width="41" height="1"><input type="image" src="../images/layout/aspheutesearchenter.gif" border="0" width="49" height="14"><br>
<span class="spacer4"><br></span>
</div>
</form>
</td>
</tr>
<tr>
<td class="empty" width="110">
&nbsp;
</td>
</tr>
<tr>
<td background="../images/layout/aspheuteheaderext.gif" class="header" width="110">
<p class="content">
<a href="/REMOVED/" title="Our most popular articles translated into English">English Articles</a><br>
<a href="/REMOVED/" title="Visit our Chinese content section">Chinese Articles</a><br>
<a href="../autoren/UnsereAutoren.htm" title="Unsere Autoren">Unsere Autoren</a><br>
&nbsp;<br>
<a href="/REMOVED/link2us.asp" title="Setzen Sie einen Link zu AspHeute!">Link zu AspHeute</a><br>
<a href="/REMOVED/impressum.asp" title="Das Impressum von AspHeute">Impressum</a><br>
<a href="/REMOVED/advertise.asp" title="Werben auch Sie auf AspHeute">Werben</a><br>
<a href="/REMOVED/kontakt.asp" title="Teilen Sie uns Ihre W&uuml;nsche, Beschwerden und Anregungen mit">Anfragen</a><br>
</p>
</td>
</tr>
</table>
</div>



<!-- Content starts here  -->
<div style="position:absolute;left:120px;top:108px">
<table cellspacing="0" cellpadding="0"><!--Tabelle aussen-->
<tr><!--Tabelle aussen, 1/2-->
<td><!--Tabelle aussen, 1/1-->
    <table border=0 align=center><tr><td align=center>


</td></tr></table>

<H1>Verhinderung von SQL Injection Marke .NET</H1>
<p>
Geschrieben von: <a href="../autoren/christophwille.htm">Christoph Wille</a><br>
Kategorie: <a href="../kategorien/Sicherheit.htm">Sicherheit</a><br>
<SCRIPT src="/service/artikelbewertung.asp?Artikel=20011203"></SCRIPT>
</p>
<p>
Was <a href="20011030.htm">SQL Injection</a> ist, hat der erste Artikel dieser Serie ausf&uuml;hrlich erkl&auml;rt und auch demonstriert.
In Folge 2, <a href="20011031.htm">Gegengifte f&uuml;r SQL Injection</a>, ging es dann
um Wege mittels Inputvalidierung SQL Injection zu verhindern, und auch mittels ADO eine Art letzte
Bastion zu errichten. Heute wechseln wir von ASP nach ASP.NET, und von ADO zu ADO.NET - und sehen
uns die dortigen Abwehrmethoden an.
</p>
<p>
Ich m&ouml;chte auch heute wieder den Spruch Michael Howard's wiederholen: <b>All input is evil, until proven otherwise!</b>
</p>
<p>
Wie man Input validieren kann, haben wir im Artikel <a href="20011031.htm">Gegengifte f&uuml;r SQL Injection</a>
bereits besprochen. Als wichtigste Waffe zur Validierung des Inputs stehen unter .NET (&Uuml;berraschung!)
Regular Expressions zur Verf&uuml;gung - wer also in ASP RegEx gelernt hat, kann dieses Wissen unter .NET
wieder einsetzen. Wer's noch nicht gemerkt hat: ich halte RegEx f&uuml;r eine der wichtigsten Techniken
die ein Programmierer beherrschen sollte.
</p>

<p>
Mit Inputvalidierung werden wir uns heute au&szlig;er im obigen Absatz nicht weiter besch&auml;ftigen - statt
dessen m&ouml;chte ich Codebeispiele zeigen: zuallererst eines, das man sich als schlechtes Beispiel unbedingt
immer vor Augen halten sollte, sowie ein weiteres, das man sich aus anderen Gr&uuml;nden merken sollte: weil
man in Zukunft nur noch so programmieren sollte!
</p>

<h2>So in Zukunft nicht mehr</h2>
<p>
Ich habe ein Beispiel nach alter Verfahrensweise geschrieben - der SQL String wird dynamisch
zusammengebaut, was bei unzureichender &Uuml;berpr&uuml;fung der &uuml;bergebenen Daten zur SQL Injection
f&uuml;hrt (<b>jessas.aspx</b>):
</p>

<pre style="background='silver';">
&lt;%@Page Language="C#" %&gt;
&lt;%@Import Namespace="System.Data" %&gt;
&lt;%@Import Namespace="System.Data.SqlClient" %&gt;
&lt;%
string strImagineAsQuerystring = "HANAR";

string strConn = "user id=restricted;password=uX98x00;initial catalog=northwind;" + 
                     "data source=WEBDEVSRV01;Connect Timeout=30";
SqlConnection scNWind = new SqlConnection(strConn);
scNWind.Open();

SqlCommand cmd = new SqlCommand();
cmd.CommandText = "select sum(freight) from Orders " + 
        " where CustomerId = '" + strImagineAsQuerystring + "'";
cmd.Connection = scNWind;

object RetVal = cmd.ExecuteScalar();
Response.Write(RetVal.ToString());

cmd.Dispose();
scNWind.Close();
%&gt;
</pre>

<p>
Ist die Variable <i>strImagineAsQuerystring</i> nicht gen&uuml;gend &uuml;berpr&uuml;ft, so kann ein Hacker wie im
Artikel <a href="20011030.htm">SQL Injection</a> beschrieben, ein beliebiges SQL
Kommando gegen die Datenbank absetzen. Die &Uuml;berpr&uuml;fung (Inputvalidierung) sollte man also auf F&auml;lle durchf&uuml;hren -
und zwar am besten mit Regular Expressions, siehe dazu auch die Hinweise/Links im Artikel
<a href="20011031.htm">Gegengifte f&uuml;r SQL Injection</a>.
</p>
<p>
Aber ADO.NET hat noch ein zus&auml;tzliches "Zuckerl" f&uuml;r uns, das den Hahn f&uuml;r immer zudreht - und um
einiges bequemer funktioniert als in ADO.
</p>

<h2>Parametrisierte Abfragen</h2>
<p>
Vorhang auf f&uuml;r parametrisierte Abfragen, den "kleinen Bruder" (oder Schwester, falls man 
politisch korrekt sein m&ouml;chte) von Stored Procedures. Wer keine Stored
Procedures verwenden will oder kann, findet in parametrisierten Abfragen sicherlich eine
probate "last line of defense" gegen SQL Injection.
</p>
<p>
Somit ohne weitere Umschweife zu einem Beispiel (<b>mitgenuss.aspx</b>):
</p>

<pre style="background='silver';">
&lt;%@Page Language="C#" Debug="True" %&gt;
&lt;%@Import Namespace="System.Data" %&gt;
&lt;%@Import Namespace="System.Data.SqlClient" %&gt;
&lt;%
string strImagineAsQuerystring = "HANAR";
// uncomment line below to try SQL Injection (will fail)
// strImagineAsQuerystring = "' DELETE Orders --";

string strConn = "user id=sa;password=;initial catalog=northwind;" + 
                 "data source=WEBDEVSRV01;Connect Timeout=30";
SqlConnection scNWind = new SqlConnection(strConn);
scNWind.Open();

SqlCommand cmd = new SqlCommand();
cmd.CommandText = "select OrderId from Orders where CustomerId = @ParameterCustomerId";
SqlParameter param = cmd.Parameters.Add("@ParameterCustomerId", strImagineAsQuerystring);
cmd.Connection = scNWind;

SqlDataReader MySqlReader = cmd.ExecuteReader();
while (MySqlReader.Read())
{
    Response.Write(MySqlReader.GetInt32(0) + "&lt;br&gt;\r\n");
}
MySqlReader.Close();

cmd.Dispose();
scNWind.Close();
%&gt;
</pre>

<p>
Der richtig interessante Part ist der <i>CommandText</i>, also unser SQL Statement:
</p>

<pre style="background='silver';">
cmd.CommandText = "select OrderId from Orders where CustomerId = @ParameterCustomerId";
</pre>

<p>
Hier steht ab sofort ein Platzhalter, nicht einmal mehr Apostrophe, obwohl es sich um ein Textfeld
handelt. Klarerweise mu&szlig; man den Wert dieses Parameters vor der Ausf&uuml;hrung bekanntgeben, dies geschieht
so:
</p>

<pre style="background='silver';">
SqlParameter param = cmd.Parameters.Add("@ParameterCustomerId", strImagineAsQuerystring);
</pre>

<p>
Im Prinzip funktioniert alles genau gleich wie bei Stored Procedures, und mehr zu Stored Procedures
in ADO.NET bietet der Artikel <a href="20010626.htm">Stored Procedures 101 in ADO.NET</a>.
Apropos Stored Procedures - es w&auml;re an der Zeit, sich neben Regular Expressions auch mit diesen etwas
n&auml;her auseinanderzusetzen.
</p>


<h2>Schlu&szlig;bemerkung</h2>
<p>
SQL Injection verschwindet auch unter .NET nicht einfach magisch. Man mu&szlig; nachhelfen, aber wenn man seine
Applikation von vorne herein mit Blickpunkt Sicherheit plant und programmiert, ist es kein Problem.
</p>
<h2>Download des Codes</h2>
<p><a href="../Code/20011203.zip">Klicken Sie hier</a>, um den Download zu starten.</p>
<h2>Verwandte Artikel</h2>
<p>
<a href="20020705.htm">Formularbasierte Authentifizierung in f&uuml;nf Minuten</a><br>
<a href="20011031.htm">Gegengifte f&uuml;r SQL Injection</a><br>
<a href="20011206.htm">Performancemessungen in .NET</a><br>
<a href="20020902.htm">Regex'en zu Assemblies kompilieren</a><br>
<a href="20000829.htm">Regul&auml;re Ausdr&uuml;cke / Regular Expressions</a><br>
<a href="20011030.htm">SQL Injection</a><br>
<a href="20010626.htm">Stored Procedures 101 in ADO.NET</a><br>
<a href="20020131.htm">Vorsicht Falle: Dateien, die keine sind</a><br>

</p>

<h2>Wenn Sie jetzt Fragen haben...</h2>
<p>
Wenn Sie Fragen rund um die in diesem Artikel vorgestellte Technologie haben, dann schauen Sie einfach bei uns
in den <a href="http://glengamoi.com/forums/">Community Foren der deutschen .NET Community</a> vorbei. Die Teilnehmer 
helfen Ihnen gerne, wenn Sie sich zur im Artikel vorgestellten Technologie weiterbilden m&ouml;chten.
</p>

<p>
<a href="http://glengamoi.com/forums/"><img src="../images/glengamoi.com_250.gif" width="250" height="80" alt="" border="0"></a>
</p>


<p>
Haben Sie Fragen die sich direkt auf den Inhalt des Artikels beziehen, dann schreiben Sie dem Autor! Unsere Autoren
freuen sich &uuml;ber Feedback zu ihren Artikeln. Ein einfacher Klick auf die <i>Autor kontaktieren</i>
Schaltfl&auml;che (weiter unten) und schon haben Sie ein f&uuml;r diesen Artikel personalisiertes Anfrageformular.
</p>

<p>&nbsp;</p>
<p>
Und zu guter Letzt m&ouml;chten wir Sie bitten, den Artikel zu bewerten. Damit helfen Sie uns, 
die Qualit&auml;t der Artikel zu verbessern - und anderen Lesern bei der Auswahl der Artikel,
die sie lesen sollten.
</p>

<FORM METHOD="POST" STYLE="margin-bottom: 0px;" NAME="formRating" ACTION="/service/bewerten.asp">
<INPUT TYPE="HIDDEN" NAME="ArticleId" VALUE="20011203" />
<CENTER>
<TABLE BORDER="0" CELLSPACING="0" CELLPADDING="0">
<TR>
	<TD ALIGN="CENTER" VALIGN="MIDDLE" COLSPAN="7">Bewerten Sie diesen Artikel</TD>
</TR>
<TR>
	<TD><EM>&nbsp;Sehr gut&nbsp;</EM></TD>
	<TD><INPUT TYPE="radio" value="1" NAME="radioRating" /></TD>
	<TD><INPUT TYPE="radio" value="2" NAME="radioRating" /></TD>
	<TD><INPUT TYPE="radio" value="3" NAME="radioRating" /></TD>
	<TD><INPUT TYPE="radio" value="4" NAME="radioRating" /></TD>
	<TD><INPUT TYPE="radio" value="5" NAME="radioRating" /></TD>
	<TD ALIGN="right"><EM>&nbsp;Nicht gen&uuml;gend</EM></TD>
	<TD ROWSPAN="2" VALIGN="middle">&nbsp;<INPUT TYPE="submit" VALUE="Werten!" /></TD>
</TR>
<TR>
	<TD>&nbsp;</TD>
	<TD ALIGN="CENTER">&nbsp;1</TD>
	<TD ALIGN="CENTER">&nbsp;2</TD>
	<TD ALIGN="CENTER">&nbsp;3</TD>
	<TD ALIGN="CENTER">&nbsp;4</TD>
	<TD ALIGN="CENTER">&nbsp;5</TD>
	<TD>&nbsp;</TD>
</TR>
</TABLE>
</FORM>
</center>
&nbsp;<P>
<center>
<p><table><tr><td valign=top>
<form action="REMOVED" method="GET"><input type="hidden" name="pagetitle" value="Verhinderung von SQL Injection Marke .NET"><input type="hidden" name="pageurl" value="http://www.aspheute.com/artikel/20011203.htm"><input type="image" src="../images/layout/senden.png" width="107" height="20" border="0" alt="Schicken Sie diese Seite einem Freund!" style="cursor='hand';"></form>
<td>&nbsp;&nbsp;</td>
<td valign=top>
<form action="REMOVED" method="GET"><input type="hidden" name="Author" value="Christoph Wille"><input type="hidden" name="AuthorEmail" value="christophw@alphasierrapapa.com"><input type="hidden" name="Artikel" value="20011203"><input type="image" src="../images/layout/kontakt.png" width="107" height="20" border="0" alt="Kontaktieren Sie den Autor!" style="cursor='hand';"></form>
<td>&nbsp;&nbsp;</td>
<td valign=top><a href="../PrinterFriendly/20011203.htm"><img src="../images/layout/druck.png" width="118" height="20" border="0" alt="F&uuml;r Ausdruck optimierte Seite"></a></td>
</tr></table></p>
</center>

<center>
<p class="content">
&copy;2000-2006 <A HREF="../service/copyright.htm" title="Copyright Informationen">AspHeute.com</A><br>
Alle Rechte vorbehalten. Der Inhalt dieser Seiten ist urheberrechtlich gesch&uuml;tzt.<br>
Eine &Uuml;bernahme von Texten (auch nur auszugsweise) oder Graphiken bedarf unserer schriftlichen Zustimmung.
<hr>
</p>
</center>

</td>
</tr><!--Tabelle aussen, 2/2-->
</table><!--Tabelle aussen-->
</div>

</BODY>
</HTML>
